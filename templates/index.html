<!--
Author: Boaz Bilgory
Description: Web UI for configuring and running best race results analysis.
Performance: Lightweight UI; heavy work is delegated to the Flask backend.
*Created: 16/11/2025*  *Last update: 20/11/2025*
-->
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Best Race Results GUI</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        #loading {
            display: none;
            font-size: 20px;
            margin-top: 15px;
            color: #444;
            text-align: center;
        }
        #loading-seconds {
            font-weight: bold;
            font-size: 1.4em;
        }

        .form-label {
            font-weight: 700;
            display: block;
            text-align: left;
        }

        .form-control {
            background-color: #e0e0e0;
        }

        .form-control::placeholder {
            text-align: left;
        }

        .loading-step {
            font-size: 0.9rem;
            opacity: 0.5;
        }

        .loading-step.active {
            font-weight: 600;
            opacity: 1;
        }

        /* Theme styles */
        body.theme-dark {
            background-color: #121212 !important;
            color: #f5f5f5;
        }

        body.theme-dark .form-control {
            background-color: #3a3a3a;
            color: #f5f5f5;
            border-color: #555;
        }

        body.theme-dark .card {
            background-color: #1e1e1e;
            color: #f5f5f5;
        }

        body.theme-dark .table {
            background-color: #1e1e1e !important;
            color: #f5f5f5 !important;
            border-color: #555 !important;
        }

        body.theme-dark .table thead th {
            background-color: #2f2f2f !important;
            color: #f5f5f5 !important;
            border-color: #555 !important;
        }

        body.theme-dark .table tbody td {
            background-color: #1e1e1e !important;
            color: #f5f5f5 !important;
            border-color: #555 !important;
        }

        body.theme-dark .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: #2a2a2a !important;
        }

        body.theme-dark .table-striped > tbody > tr:nth-of-type(even) > * {
            background-color: #1e1e1e !important;
        }

        body.theme-dark .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        body.theme-dark .btn-outline-secondary {
            color: #f5f5f5;
            border-color: #6c757d;
        }

        body.theme-dark #loading {
            color: #f5f5f5;
        }
    </style>

    <script>
        let loadingTimerInterval;
        let loadingStartTime;

        function setLoadingStep(stepNumber) {
            const steps = [
                document.getElementById("loading-step-1"),
                document.getElementById("loading-step-2"),
                document.getElementById("loading-step-3"),
            ];

            steps.forEach((el, index) => {
                if (!el) return;
                if (index === stepNumber - 1) {
                    el.classList.add("active");
                } else {
                    el.classList.remove("active");
                }
            });
        }

        function startLoading() {
            const loadingEl = document.getElementById("loading");
            const secondsEl = document.getElementById("loading-seconds");
            const submitBtn = document.getElementById("submit-button");

            if (loadingEl) {
                loadingEl.style.display = "block";
            }

            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = "Running...";
            }

            if (secondsEl) {
                secondsEl.textContent = "0.0";
                loadingStartTime = Date.now();
                loadingTimerInterval = setInterval(function () {
                    const elapsedSeconds = (Date.now() - loadingStartTime) / 1000;
                    secondsEl.textContent = elapsedSeconds.toFixed(1);
                }, 100);
            }

            // Show pseudo progress steps while processing
            setLoadingStep(1);
            setTimeout(function () { setLoadingStep(2); }, 1500);
            setTimeout(function () { setLoadingStep(3); }, 3000);
        }

        function applySavedTheme() {
            const saved = localStorage.getItem("theme") || "light";
            const toggleBtn = document.getElementById("theme-toggle");

            if (saved === "dark") {
                document.body.classList.add("theme-dark");
                if (toggleBtn) {
                    toggleBtn.textContent = "Light mode";
                }
            } else {
                document.body.classList.remove("theme-dark");
                if (toggleBtn) {
                    toggleBtn.textContent = "Dark mode";
                }
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle("theme-dark");
            const toggleBtn = document.getElementById("theme-toggle");

            if (toggleBtn) {
                toggleBtn.textContent = isDark ? "Light mode" : "Dark mode";
            }

            localStorage.setItem("theme", isDark ? "dark" : "light");
        }

        document.addEventListener("DOMContentLoaded", function () {
            applySavedTheme();
            const toggleBtn = document.getElementById("theme-toggle");
            if (toggleBtn) {
                toggleBtn.addEventListener("click", toggleTheme);
            }
        });
    </script>
</head>

<body class="bg-light">

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">üèÉ‚Äç‚ôÇÔ∏è Best Race Results ‚Äî GUI</h2>
        <button type="button" id="theme-toggle" class="btn btn-outline-secondary btn-sm">Dark mode</button>
    </div>

    <!-- Timer / loading indicator -->
    <div id="loading">
        ‚è≥ Processing‚Ä¶ please wait‚Ä¶
        <div>
            ◊ñ◊û◊ü ◊©◊ó◊ú◊£: <span id="loading-seconds">0</span> ◊©◊†◊ô◊ï◊™
        </div>
        <div id="loading-steps" class="mt-2">
            <div id="loading-step-1" class="loading-step active">Step 1/3: Scraping participants‚Ä¶</div>
            <div id="loading-step-2" class="loading-step">Step 2/3: Filtering participants‚Ä¶</div>
            <div id="loading-step-3" class="loading-step">Step 3/3: Computing best results‚Ä¶</div>
        </div>
    </div>

    <!-- MAIN FORM (no nesting!) -->
    <form method="POST" class="card p-4 shadow" onsubmit="startLoading()">

        <div class="mb-3">
            <label class="form-label">Event URL:</label>
            <input name="event_url" type="text" class="form-control" required
                   placeholder="Example: https://regi.3plus.co.il/events/page/17401"
                   style="direction: ltr; text-align: left;">
        </div>

        <div class="mb-3">
            <label class="form-label">Race Name:</label>
            <input name="race_name" type="text" class="form-control" required
                   placeholder="Example: ◊ë◊ê◊® ◊ô◊¢◊ß◊ë"
                   style="text-align: left;">
        </div>

        <div class="row">
            <div class="col">
                <label class="form-label">Minimum Age:</label>
                <input name="min_age" type="number" class="form-control" min="0" max="120" value="40" placeholder="e.g., 40">
            </div>
            <div class="col">
                <label class="form-label">Maximum Age:</label>
                <input name="max_age" type="number" class="form-control" min="0" max="120" value="49" placeholder="e.g., 49">
            </div>
        </div>

        <div class="row mt-3">
            <div class="col">
                <label class="form-label">Gender:</label>
                <select name="gender" class="form-control">
                    <option value="male">◊ñ◊õ◊®</option>
                    <option value="female">◊†◊ß◊ë◊î</option>
                </select>
            </div>
            <div class="col">
                <label class="form-label">Current Race Category:</label>
                <select name="race_keyword" class="form-control">
                    <option value="5">5K</option>
                    <option value="10" selected>10K</option>
                    <option value="21">21K</option>
                </select>
            </div>
        </div>

        <div class="col">
            <label class="form-label">Best Result Category:</label>
            <select name="category" class="form-control">
                <option value="5K">5K</option>
                <option value="10K" selected>10K</option>
                <option value="21K">21K</option>
            </select>
        </div>

        <button id="submit-button" class="btn btn-primary mt-4 w-100">Run</button>

    </form>

    {% if done %}
    <h3 class="mt-5 text-center">Top 10 Results</h3>
    <div class="mt-3">
        {{ table_html|safe }}
    </div>

    <div class="text-center mt-4">
        <a href="/download?path={{ download_link }}" class="btn btn-success btn-lg">
            ‚¨áÔ∏è Download Full Excel File
        </a>
    </div>
    {% endif %}
</div>

</body>
</html>
